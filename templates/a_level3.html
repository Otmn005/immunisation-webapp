
{% extends "base.html" %}

{% block title %}A-Level 3 - Improvement Analysis{% endblock %}

{% block content %}
<section class="page-header">
    <h2>Vaccination Rate Improvement Analysis</h2>
    <p>Identify countries with the biggest improvements in vaccination coverage over time.</p>
</section>

<!-- Error message display -->
{% if error_message %}
<div class="alert alert-error" role="alert" aria-live="polite">
    <strong>Error:</strong> {{ error_message }}
</div>
{% endif %}

<!-- Filter form -->
<section class="filter-section">
    <h3>Analysis Parameters</h3>
    <form method="POST" action="{{ url_for('a_level3') }}" class="filter-form">
        <div class="form-row">
            <div class="form-group">
                <label for="start_year">Start Year:</label>
                <select id="start_year" name="start_year" required aria-label="Select start year" aria-required="true">
                    <option value="">-- Choose start year --</option>
                    {% for year in years %}
                    <option value="{{ year }}" {% if start_year and start_year == year|string %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="end_year">End Year:</label>
                <select id="end_year" name="end_year" required aria-label="Select end year" aria-required="true">
                    <option value="">-- Choose end year --</option>
                    {% for year in years %}
                    <option value="{{ year }}" {% if end_year and end_year == year|string %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="antigen">Antigen Type:</label>
                <select id="antigen" name="antigen" required aria-label="Select antigen type" aria-required="true">
                    <option value="">-- Choose an antigen --</option>
                    {% for antigen in antigens %}
                    <option value="{{ antigen }}" {% if selected_antigen == antigen %}selected{% endif %}>{{ antigen }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="top_n">Number of Countries:</label>
                <input type="number" id="top_n" name="top_n" min="1" max="50" value="{{ top_n }}" required 
                       aria-label="Number of top countries to display" aria-required="true">
            </div>
        </div>

        <button type="submit" class="btn btn-primary" aria-label="Analyze vaccination improvements">Analyze Improvements</button>
    </form>
</section>

<!-- Results section -->
{% if start_year and end_year and selected_antigen %}
<section class="results-section">
    <h3>Top Countries with Biggest Improvement: {{ selected_antigen }} ({{ start_year }} - {{ end_year }})</h3>

    {% if results %}
    <div class="table-container">
        <table class="data-table" role="table" aria-label="Countries with largest vaccination rate improvements">
            <thead>
                <tr>
                    <th scope="col">Rank</th>
                    <th scope="col">Country</th>
                    <th scope="col">Coverage Increase (%)</th>
                    <th scope="col">Start Coverage ({{ start_year }})</th>
                    <th scope="col">End Coverage ({{ end_year }})</th>
                </tr>
            </thead>
            <tbody>
                {% for row in results %}
                <tr>
                    <td><strong>{{ loop.index }}</strong></td>
                    <td>{{ row['country_name'] }}</td>
                    <td class="highlight"><strong>+{{ "%.2f"|format(row['rate_increase']) }}%</strong></td>
                    <td>{{ "%.1f"|format(row['start_coverage']) }}%</td>
                    <td>{{ "%.1f"|format(row['end_coverage']) }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <p class="result-count" aria-live="polite">Showing top {{ results|length }} countries</p>
    </div>

    <!-- Summary information -->
    <div class="info-box">
        <h4>Analysis Summary</h4>
        <p>
            This analysis shows countries that achieved the highest increase in {{ selected_antigen }} 
            vaccination coverage between {{ start_year }} and {{ end_year }}. A positive coverage increase 
            indicates improved vaccination rates during this period.
        </p>
    </div>
    {% else %}
    <div class="alert alert-info" role="alert" aria-live="polite">
        No improvement data found for {{ selected_antigen }} between {{ start_year }} and {{ end_year }}. 
        This may occur if:
        <ul>
            <li>No countries showed improvement during this period</li>
            <li>Data is unavailable for the selected years</li>
            <li>The end year is before or same as the start year</li>
        </ul>
    </div>
    {% endif %}
</section>
{% endif %}

<!-- Instructions -->
{% if not start_year or not end_year or not selected_antigen %}
<section class="info-box">
    <h3>How to Use This Analysis</h3>
    <ol>
        <li>Select a <strong>start year</strong> and <strong>end year</strong> to define the time period</li>
        <li>Choose an <strong>antigen type</strong> (e.g., MCV1, DTP3, RCV1)</li>
        <li>Specify how many <strong>top countries</strong> you want to see (1-50)</li>
        <li>Click "Analyze Improvements" to view countries with the biggest coverage increases</li>
    </ol>
    <p>This helps identify which countries have made the most progress in vaccination programs.</p>
</section>
{% endif %}
{% endblock %}
